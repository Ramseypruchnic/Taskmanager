<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Business Task Manager</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f3f4f6; 
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .card { 
            background: white; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .header { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 1.5rem; 
        }
        .nav { display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .nav-btn { 
            padding: 0.5rem 1rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .nav-btn.active { background: #3b82f6; color: white; }
        .nav-btn:not(.active) { background: #e5e7eb; color: #374151; }
        .nav-btn:hover:not(.active) { background: #d1d5db; }
        
        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 1rem;
        }
        .user-avatar { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
        }
        .sync-status { 
            padding: 0.25rem 0.5rem; 
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
            font-weight: 500;
        }
        .sync-success { background: #f0fdf4; color: #065f46; }
        .sync-pending { background: #fef3c7; color: #92400e; }
        .sync-error { background: #fef2f2; color: #991b1b; }
        .sync-offline { background: #f3f4f6; color: #6b7280; }
        
        .login-container { 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .login-card { 
            background: white; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            padding: 2rem; 
            max-width: 400px; 
            width: 100%;
            text-align: center;
        }
        
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151; }
        .text-input { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #d1d5db; 
            border-radius: 0.5rem; 
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .text-input:focus { outline: none; border-color: #3b82f6; }
        
        .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .radio-item input { width: 1rem; height: 1rem; }
        
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.75rem; }
        
        .task-item { 
            border: 2px solid #e5e7eb; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .task-item.personal { border-color: #bfdbfe; background: #eff6ff; }
        .task-item.strategylabs { border-color: #c4b5fd; background: #f3f4f6; }
        .task-item.unomas { border-color: #fed7aa; background: #fff7ed; }
        
        .checkbox { 
            width: 1.25rem; 
            height: 1.25rem; 
            border: 2px solid #d1d5db; 
            border-radius: 0.25rem; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.125rem;
        }
        .checkbox.checked { background: #10b981; border-color: #10b981; color: white; }
        
        .task-content { flex: 1; }
        .task-text { margin-bottom: 0.5rem; }
        .task-text.completed { text-decoration: line-through; color: #6b7280; }
        .task-meta { display: flex; gap: 0.5rem; align-items: center; }
        .badge { 
            padding: 0.25rem 0.5rem; 
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
            font-weight: 500; 
        }
        .badge-personal { background: #3b82f6; color: white; }
        .badge-strategylabs { background: #8b5cf6; color: white; }
        .badge-unomas { background: #f97316; color: white; }
        .badge-high { background: #fef2f2; color: #991b1b; }
        .badge-medium { background: #fefce8; color: #a16207; }
        .badge-low { background: #f3f4f6; color: #374151; }
        
        .task-actions { display: flex; gap: 0.25rem; }
        .icon-btn { 
            padding: 0.25rem; 
            border: none; 
            background: none; 
            cursor: pointer; 
            border-radius: 0.25rem;
            color: #6b7280;
        }
        .icon-btn:hover { background: #f3f4f6; }
        .icon-btn.primary { color: #3b82f6; }
        .icon-btn.danger { color: #ef4444; }
        
        .category-section { border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; }
        .category-header { 
            padding: 0.75rem; 
            background: #f9fafb; 
            border-bottom: 1px solid #e5e7eb; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .category-header:hover { background: #f3f4f6; }
        .category-content { padding: 0.75rem; }
        
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: none;
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            max-width: 500px; 
            width: 90%; 
            margin: 1rem;
        }
        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }
        
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        
        .alert { 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            margin-bottom: 1rem; 
            border-left: 4px solid;
        }
        .alert-warning { background: #fefce8; border-color: #f59e0b; color: #92400e; }
        .alert-success { background: #f0fdf4; border-color: #10b981; color: #065f46; }
        .alert-info { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
        
        .text-center { text-align: center; }
        .text-gray { color: #6b7280; }
        .text-lg { font-size: 1.125rem; }
        .font-bold { font-weight: 700; }
        .mb-4 { margin-bottom: 1rem; }
        .py-8 { padding: 2rem 0; }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .nav { flex-wrap: wrap; }
            .radio-group { flex-direction: column; gap: 0.5rem; }
            .grid-2 { grid-template-columns: 1fr; }
            .user-info { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div id="login-screen" class="login-container">
        <div class="login-card">
            <h1 class="text-lg font-bold mb-4">Multi-Business Task Manager</h1>
            <p class="text-gray mb-4">Sign in with Google to sync your tasks across all devices</p>
            
            <div id="google-signin-btn" class="mb-4"></div>
            
            <div style="margin: 1rem 0; display: flex; align-items: center; gap: 1rem;">
                <hr style="flex: 1; border: none; border-top: 1px solid #e5e7eb;">
                <span style="color: #6b7280; font-size: 0.875rem;">or</span>
                <hr style="flex: 1; border: none; border-top: 1px solid #e5e7eb;">
            </div>
            
            <button class="btn btn-secondary" onclick="useOfflineMode()">
                📱 Use Offline Mode
            </button>
            
            <p style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;">
                Offline mode saves tasks only on this device.<br>
                Sign in with Google to sync across all your devices.
            </p>
        </div>
    </div>

    <div id="main-app" class="container hidden">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                <h1 class="text-lg font-bold">Multi-Business Task Manager</h1>
                <div class="user-info" id="user-info">
                    <img id="user-avatar" class="user-avatar" src="" alt="">
                    <span id="user-name"></span>
                    <span class="sync-status sync-offline" id="sync-status">📱 Offline</span>
                    <button class="btn btn-sm btn-secondary" onclick="signOut()">Sign Out</button>
                </div>
            </div>
            <div class="nav">
                <button class="nav-btn active" onclick="showView('capture')" id="capture-btn">📝 Capture & Organize</button>
                <button class="nav-btn" onclick="showView('daily')" id="daily-btn">🎯 Daily Focus</button>
                <button class="nav-btn" onclick="syncNow()" id="sync-btn" title="Sync with Google Drive">☁️ Sync Now</button>
                <button class="nav-btn" onclick="exportTasks()" title="Download backup">💾 Download Backup</button>
            </div>
        </div>
        
        <div id="sync-alert" class="alert alert-info hidden">
            <strong>📡 Syncing with Google Drive...</strong> Your tasks are being saved to the cloud.
        </div>
        
        <div id="capture-view">
            <div class="card">
                <h2 class="font-bold mb-4">Quick Capture</h2>
                
                <div class="input-group">
                    <input type="text" id="task-input" class="text-input" placeholder="Enter your task here..." onkeydown="handleTaskInput(event)">
                </div>
                
                <div class="input-group">
                    <label>Category</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="category" value="personal" checked>
                            <span>Personal</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="category" value="strategylabs">
                            <span>Strategy Labs</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="category" value="unomas">
                            <span>Uno Mas</span>
                        </label>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Priority</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="priority" value="high">
                            <span class="badge badge-high">High</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="priority" value="medium" checked>
                            <span class="badge badge-medium">Medium</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="priority" value="low">
                            <span class="badge badge-low">Low</span>
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addTask()">➕ Add Task</button>
            </div>
            
            <div class="card">
                <h2 class="font-bold mb-4">All Tasks (<span id="total-tasks">0</span>)</h2>
                <div id="tasks-container">
                    <p class="text-center text-gray py-8">No tasks yet. Start capturing your thoughts above!</p>
                </div>
            </div>
        </div>
        
        <div id="daily-view" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 class="font-bold">Today's Focus (<span id="daily-count">0</span>/10 active tasks)</h2>
                    <div class="text-gray" id="current-date"></div>
                </div>
                
                <div id="daily-limit-warning" class="alert alert-warning hidden">
                    📋 Daily limit reached! Focus on completing tasks before adding more.
                </div>
                
                <div id="daily-tasks-container">
                    <div class="text-center py-8">
                        <p class="text-gray mb-4">No tasks selected for today.</p>
                        <button class="btn btn-primary" onclick="showView('capture')">Add Tasks from Capture</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="completion-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold mb-4">Daily Review</h3>
            <p id="completion-message" class="mb-4"></p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="clearCompleted()">Clear Completed & Add New Tasks</button>
                <button class="btn btn-secondary" onclick="hideCompletionModal()">Keep All Tasks</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Your actual Google API credentials
        const CLIENT_ID = '702434826627-h2kpu9a5nhl9946odoogcqb44p0heq6t.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDjlEytdQToEPzfhmCl_rsCVn8yL00guzc';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Global state
        let tasks = [];
        let dailyTasks = [];
        let currentView = 'capture';
        let currentUser = null;
        let isSignedIn = false;
        let gapi = null;
        let tokenClient = null;
        let driveFileId = null;

        // Categories configuration
        const categories = {
            personal: { name: 'Personal', badge: 'badge-personal' },
            strategylabs: { name: 'Strategy Labs', badge: 'badge-strategylabs' },
            unomas: { name: 'Uno Mas', badge: 'badge-unomas' }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeGoogleAPI();
        });

        async function initializeGoogleAPI() {
            try {
                // Load Google API
                await new Promise((resolve, reject) => {
                    if (typeof window.gapi !== 'undefined') {
                        resolve();
                    } else {
                        const script = document.createElement('script');
                        script.src = 'https://apis.google.com/js/api.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    }
                });

                await window.gapi.load('client', initializeGapiClient);
                
                // Initialize Google Identity Services
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                });

                // Render sign-in button
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse
                });

                google.accounts.id.renderButton(
                    document.getElementById('google-signin-btn'),
                    { theme: 'outline', size: 'large', width: 250 }
                );

            } catch (error) {
                console.error('Error initializing Google API:', error);
                showOfflineMode();
            }
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
        }

        function handleCredentialResponse(response) {
            // Parse the JWT token
            const userInfo = parseJwt(response.credential);
            currentUser = {
                id: userInfo.sub,
                email: userInfo.email,
                name: userInfo.name,
                picture: userInfo.picture
            };
            
            // Request additional permissions for Drive access
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        function handleAuthCallback(resp) {
            if (resp.error !== undefined) {
                console.error('Auth error:', resp.error);
                return;
            }
            
            isSignedIn = true;
            showMainApp();
            loadFromGoogleDrive();
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function useOfflineMode() {
            currentUser = { offline: true, name: 'Offline User' };
            isSignedIn = false;
            showMainApp();
            loadFromLocalStorage();
            updateCurrentDate();
            renderTasks();
            renderDailyTasks();
        }

        function showOfflineMode() {
            document.getElementById('google-signin-btn').innerHTML = 
                '<p style="color: #ef4444; margin: 1rem 0;">Google Sign-in unavailable. Using offline mode.</p>';
            useOfflineMode();
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Update user info
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.name;
                if (currentUser.picture) {
                    document.getElementById('user-avatar').src = currentUser.picture;
                    document.getElementById('user-avatar').style.display = 'block';
                } else {
                    document.getElementById('user-avatar').style.display = 'none';
                }
                
                updateSyncStatus(currentUser.offline ? 'offline' : 'synced');
            }
            
            updateCurrentDate();
            renderTasks();
            renderDailyTasks();
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                currentUser = null;
                isSignedIn = false;
                driveFileId = null;
                tasks = [];
                dailyTasks = [];
                
                // Clear local storage
                localStorage.clear();
                
                // Show login screen
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        // Google Drive Functions
        async function saveToGoogleDrive() {
            if (!isSignedIn) {
                saveToLocalStorage();
                return;
            }

            try {
                updateSyncStatus('syncing');
                
                const data = {
                    tasks: tasks,
                    dailyTasks: dailyTasks,
                    lastSync: new Date().toISOString(),
                    version: '1.0'
                };

                const content = JSON.stringify(data, null, 2);
                
                if (driveFileId) {
                    // Update existing file
                    await gapi.client.drive.files.update({
                        fileId: driveFileId,
                        uploadType: 'media',
                        body: content
                    });
                } else {
                    // Create new file
                    const fileMetadata = {
                        name: 'task-manager-data.json',
                        parents: ['appDataFolder']
                    };
                    
                    const response = await gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: 'application/json',
                            body: content
                        },
                        fields: 'id'
                    });
                    
                    driveFileId = response.result.id;
                }
                
                updateSyncStatus('synced');
                
            } catch (error) {
                console.error('Error saving to Google Drive:', error);
                updateSyncStatus('error');
                // Fallback to local storage
                saveToLocalStorage();
            }
        }

        async function loadFromGoogleDrive() {
            if (!isSignedIn) {
                loadFromLocalStorage();
                return;
            }

            try {
                updateSyncStatus('syncing');
                
                // Search for existing file
                const response = await gapi.client.drive.files.list({
                    q: "name='task-manager-data.json' and parents in 'appDataFolder'",
                    spaces: 'appDataFolder'
                });

                if (response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                    
                    // Download file content
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media'
                    });

                    const data = JSON.parse(fileResponse.body);
                    
                    if (data.tasks) {
                        tasks = data.tasks;
                        // Convert date strings back to Date objects
                        tasks.forEach(task => {
                            if (task.createdAt) task.createdAt = new Date(task.createdAt);
                        });
                    }
                    
                    if (data.dailyTasks) {
                        dailyTasks = data.dailyTasks;
                        dailyTasks.forEach(task => {
                            if (task.createdAt) task.createdAt = new Date(task.createdAt);
                        });
                    }
                    
                    // Check if it's a new day
                    checkNewDay();
                    
                    updateSyncStatus('synced');
                    renderTasks();
                    renderDailyTasks();
                } else {
                    // No existing file, start fresh
                    updateSyncStatus('synced');
                }
                
            } catch (error) {
                console.error('Error loading from Google Drive:', error);
                updateSyncStatus('error');
                // Fallback to local storage
                loadFromLocalStorage();
            }
        }

        async function syncNow() {
            if (!isSignedIn) {
                alert('Sign in with Google to sync your tasks to the cloud.');
                return;
            }
            
            await saveToGoogleDrive();
        }

        // Local Storage Functions (fallback)
        function saveToLocalStorage() {
            try {
                localStorage.setItem('taskManagerTasks', JSON.stringify(tasks));
                localStorage.setItem('taskManagerDailyTasks', JSON.stringify(dailyTasks));
                localStorage.setItem('taskManagerLastSave', new Date().toISOString());
            } catch (error) {
                console.warn('Could not save to localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedTasks = localStorage.getItem('taskManagerTasks');
                const savedDailyTasks = localStorage.getItem('taskManagerDailyTasks');
                
                if (savedTasks) {
                    tasks = JSON.parse(savedTasks);
                    tasks.forEach(task => {
                        if (task.createdAt) task.createdAt = new Date(task.createdAt);
                    });
                }
                
                if (savedDailyTasks) {
                    dailyTasks = JSON.parse(savedDailyTasks);
                    dailyTasks.forEach(task => {
                        if (task.createdAt) task.createdAt = new Date(task.createdAt);
                    });
                }
                
                checkNewDay();
            } catch (error) {
                console.warn('Could not load from localStorage:', error);
                tasks = [];
                dailyTasks = [];
            }
        }

        function checkNewDay() {
            const lastSave = localStorage.getItem('taskManagerLastSave');
            if (lastSave) {
                const lastSaveDate = new Date(lastSave);
                const today = new Date();
                
                if (lastSaveDate.toDateString() !== today.toDateString()) {
                    dailyTasks = [];
                    if (isSignedIn) {
                        saveToGoogleDrive();
                    } else {
                        saveToLocalStorage();
                    }
                }
            }
        }

        function updateSyncStatus(status) {
            const statusElement = document.getElementById('sync-status');
            const syncAlert = document.getElementById('sync-alert');
            
            switch (status) {
                case 'syncing':
                    statusElement.className = 'sync-status sync-pending';
                    statusElement.textContent = '🔄 Syncing...';
                    syncAlert.classList.remove('hidden');
                    break;
                case 'synced':
                    statusElement.className = 'sync-status sync-success';
                    statusElement.textContent = '☁️ Synced';
                    syncAlert.classList.add('hidden');
                    break;
                case 'error':
                    statusElement.className = 'sync-status sync-error';
                    statusElement.textContent = '⚠️ Sync Error';
                    syncAlert.classList.add('hidden');
                    break;
                case 'offline':
                    statusElement.className = 'sync-status sync-offline';
                    statusElement.textContent = '📱 Offline';
                    syncAlert.classList.add('hidden');
                    break;
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('current-date').textContent = dateStr;
        }

        function showView(view) {
            currentView = view;
            document.getElementById('capture-view').className = view === 'capture' ? '' : 'hidden';
            document.getElementById('daily-view').className = view === 'daily' ? '' : 'hidden';
            
            document.getElementById('capture-btn').className = view === 'capture' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('daily-btn').className = view === 'daily' ? 'nav-btn active' : 'nav-btn';
            
            if (view === 'daily') {
                updateDailyView();
            }
        }

        function handleTaskInput(event) {
            if (event.key === 'Enter') {
                addTask();
            }
        }

        async function addTask() {
            const input = document.getElementById('task-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            const category = document.querySelector('input[name="category"]:checked').value;
            const priority = document.querySelector('input[name="priority"]:checked').value;
            
            const task = {
                id: Date.now(),
                text: text,
                category: category,
                priority: priority,
                completed: false,
                createdAt: new Date()
            };
            
            tasks.unshift(task);
            input.value = '';
            
            if (isSignedIn) {
                await saveToGoogleDrive();
            } else {
                saveToLocalStorage();
            }
            
            renderTasks();
        }

        async function deleteTask(id) {
            tasks = tasks.filter(task => task.id !== id);
            dailyTasks = dailyTasks.filter(task => task.id !== id);
            
            if (isSignedIn) {
                await saveToGoogleDrive();
            } else {
                saveToLocalStorage();
            }
            
            renderTasks();
            renderDailyTasks();
        }

        async function toggleTask(id) {
            const task = tasks.find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
            }
            
            const dailyTask = dailyTasks.find(task => task.id === id);
            if (dailyTask) {
                dailyTask.completed = !dailyTask.completed;
                renderDailyTasks();
                checkDailyLimit();
            }
            
            if (isSignedIn) {
                await saveToGoogleDrive();
            } else {
                saveToLocalStorage();
            }
        }

        async function addToDaily(id) {
            const task = tasks.find(task => task.id === id);
            const activeDailyTasks = dailyTasks.filter(t => !t.completed);
            
            if (task && activeDailyTasks.length < 10 && !dailyTasks.find(t => t.id === id)) {
                dailyTasks.push({...task});
                
                if (isSignedIn) {
                    await saveToGoogleDrive();
                } else {
                    saveToLocalStorage();
                }
                
                renderDailyTasks();
                updateDailyView();
            }
        }

        async function removeFromDaily(id) {
            dailyTasks = dailyTasks.filter(task => task.id !== id);
            
            if (isSignedIn) {
                await saveToGoogleDrive();
            } else {
                saveToLocalStorage();
            }
            
            renderDailyTasks();
            updateDailyView();
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            const totalTasks = tasks.length;
            
            document.getElementById('total-tasks').textContent = totalTasks;
            
            if (totalTasks === 0) {
                container.innerHTML = '<p class="text-center text-gray py-8">No tasks yet. Start capturing your thoughts above!</p>';
                return;
            }
            
            const tasksByCategory = {};
            Object.keys(categories).forEach(key => {
                tasksByCategory[key] = tasks.filter(task => task.category === key);
            });
            
            let html = '';
            Object.entries(tasksByCategory).forEach(([categoryKey, categoryTasks]) => {
                if (categoryTasks.length === 0) return;
                
                html += `
                    <div class="category-section">
                        <div class="category-header" onclick="toggleCategory('${categoryKey}')">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: ${getCategoryColor(categoryKey)};"></span>
                                <span class="font-bold">${categories[categoryKey].name} (${categoryTasks.length})</span>
                            </div>
                            <span id="chevron-${categoryKey}">▼</span>
                        </div>
                        <div class="category-content" id="content-${categoryKey}">
                            ${categoryTasks.map(task => renderTaskItem(task, true)).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderDailyTasks() {
            const container = document.getElementById('daily-tasks-container');
            const activeTasks = dailyTasks.filter(task => !task.completed);
            const completedTasks = dailyTasks.filter(task => task.completed);
            
            document.getElementById('daily-count').textContent = activeTasks.length;
            
            if (dailyTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray mb-4">No tasks selected for today.</p>
                        <button class="btn btn-primary" onclick="showView('capture')">Add Tasks from Capture</button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            if (completedTasks.length > 0) {
                html += `
                    <div class="alert alert-success">
                        <h3 class="font-bold mb-4">✅ Completed Today (${completedTasks.length})</h3>
                        ${completedTasks.map(task => renderTaskItem(task, false, true)).join('')}
                    </div>
                `;
            }
            
            if (activeTasks.length > 0) {
                const tasksByCategory = {};
                Object.keys(categories).forEach(key => {
                    tasksByCategory[key] = activeTasks.filter(task => task.category === key);
                });
                
                html += '<div class="grid grid-2">';
                Object.entries(tasksByCategory).forEach(([categoryKey, categoryTasks]) => {
                    if (categoryTasks.length === 0) return;
                    
                    html += `
                        <div>
                            <h3 class="font-bold mb-4" style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: ${getCategoryColor(categoryKey)};"></span>
                                ${categories[categoryKey].name} (${categoryTasks.length})
                            </h3>
                            ${categoryTasks.map(task => renderTaskItem(task, false, true)).join('')}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function renderTaskItem(task, showAddButton = false, fromDaily = false) {
            const activeDailyCount = dailyTasks.filter(t => !t.completed).length;
            const canAddToDaily = activeDailyCount < 10 && !dailyTasks.find(t => t.id === task.id);
            
            return `
                <div class="task-item ${task.category}">
                    <div class="checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '✓' : ''}
                    </div>
                    <div class="task-content">
                        <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                        <div class="task-meta">
                            <span class="badge ${categories[task.category].badge}">${categories[task.category].name}</span>
                            <span class="badge badge-${task.priority}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        ${showAddButton ? `
                            <button class="icon-btn primary ${!canAddToDaily ? 'hidden' : ''}" onclick="addToDaily(${task.id})" title="Add to daily tasks">
                                ➕
                            </button>
                        ` : ''}
                        ${fromDaily ? `
                            <button class="icon-btn danger" onclick="removeFromDaily(${task.id})" title="Remove from daily">
                                ❌
                            </button>
                        ` : `
                            <button class="icon-btn danger" onclick="deleteTask(${task.id})" title="Delete task">
                                🗑️
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        function getCategoryColor(category) {
            const colors = {
                personal: '#3b82f6',
                strategylabs: '#8b5cf6',
                unomas: '#f97316'
            };
            return colors[category] || '#6b7280';
        }

        function toggleCategory(categoryKey) {
            const content = document.getElementById(`content-${categoryKey}`);
            const chevron = document.getElementById(`chevron-${categoryKey}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.textContent = '▼';
            } else {
                content.style.display = 'none';
                chevron.textContent = '▶';
            }
        }

        function updateDailyView() {
            const activeTasks = dailyTasks.filter(task => !task.completed);
            const warning = document.getElementById('daily-limit-warning');
            
            if (activeTasks.length >= 10) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            renderDailyTasks();
        }

        function checkDailyLimit() {
            const completedToday = dailyTasks.filter(task => task.completed).length;
            const activeTasks = dailyTasks.filter(task => !task.completed);
            
            if (completedToday > 0 && activeTasks.length < 10) {
                showCompletionModal(completedToday, 10 - activeTasks.length);
            }
        }

        function showCompletionModal(completed, available) {
            const modal = document.getElementById('completion-modal');
            const message = document.getElementById('completion-message');
            
            message.textContent = `Great job! You completed ${completed} task(s) today. You can now add ${available} more task(s) to your daily focus.`;
            modal.classList.add('show');
        }

        function hideCompletionModal() {
            document.getElementById('completion-modal').classList.remove('show');
        }

        async function clearCompleted() {
            dailyTasks = dailyTasks.filter(task => !task.completed);
            
            if (isSignedIn) {
                await saveToGoogleDrive();
            } else {
                saveToLocalStorage();
            }
            
            hideCompletionModal();
            updateDailyView();
        }

        function exportTasks() {
            const data = {
                tasks: tasks,
                dailyTasks: dailyTasks,
                exportDate: new Date().toISOString(),
                user: currentUser ? currentUser.email : 'offline'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `task-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
