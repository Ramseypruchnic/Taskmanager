<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Business Task Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f3f4f6; 
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .card { 
            background: white; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .header { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 1.5rem; 
        }
        .nav { display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .nav-btn { 
            padding: 0.5rem 1rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .nav-btn.active { background: #3b82f6; color: white; }
        .nav-btn:not(.active) { background: #e5e7eb; color: #374151; }
        .nav-btn:hover:not(.active) { background: #d1d5db; }
        
        .input-group { margin-bottom: 1rem; }
        .input-group label { 
            display: block; 
            font-weight: 500; 
            margin-bottom: 0.5rem; 
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .text-input { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #d1d5db; 
            border-radius: 0.5rem; 
            font-size: 1rem;
            transition: border-color 0.2s;
            position: relative;
        }
        .text-input:focus { outline: none; border-color: #3b82f6; }
        
        .input-container {
            position: relative;
        }
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #3b82f6;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .suggestion-item:hover,
        .suggestion-item.active {
            background: #eff6ff;
        }
        .suggestion-type {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .radio-item input { width: 1rem; height: 1rem; }
        
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.75rem; }
        
        .edit-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        .edit-section.show { display: block; }
        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .edit-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .edit-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
        }
        .edit-item button {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.125rem;
            font-size: 1rem;
        }
        .add-item-form {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .add-item-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .task-item { 
            border: 2px solid #e5e7eb; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .task-item.personal { border-color: #bfdbfe; background: #eff6ff; }
        .task-item.strategylabs { border-color: #c4b5fd; background: #f3f4f6; }
        .task-item.unomas { border-color: #fed7aa; background: #fff7ed; }
        
        .checkbox { 
            width: 1.25rem; 
            height: 1.25rem; 
            border: 2px solid #d1d5db; 
            border-radius: 0.25rem; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.125rem;
        }
        .checkbox.checked { background: #10b981; border-color: #10b981; color: white; }
        
        .task-content { flex: 1; }
        .task-text { margin-bottom: 0.5rem; }
        .task-text.completed { text-decoration: line-through; color: #6b7280; }
        .task-meta { display: flex; gap: 0.5rem; align-items: center; }
        .badge { 
            padding: 0.25rem 0.5rem; 
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
            font-weight: 500; 
        }
        .badge-personal { background: #3b82f6; color: white; }
        .badge-strategylabs { background: #8b5cf6; color: white; }
        .badge-unomas { background: #f97316; color: white; }
        .badge-high { background: #fef2f2; color: #991b1b; }
        .badge-medium { background: #fefce8; color: #a16207; }
        .badge-low { background: #f3f4f6; color: #374151; }
        
        .task-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .icon-btn { 
            padding: 0.25rem; 
            border: none; 
            background: none; 
            cursor: pointer; 
            border-radius: 0.25rem;
            color: #6b7280;
            font-size: 1rem;
        }
        .icon-btn:hover { background: #f3f4f6; }
        .icon-btn.primary { color: #3b82f6; }
        .icon-btn.danger { color: #ef4444; }
        
        .category-section { border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; }
        .category-header { 
            padding: 0.75rem; 
            background: #f9fafb; 
            border-bottom: 1px solid #e5e7eb; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .category-header:hover { background: #f3f4f6; }
        .category-content { padding: 0.75rem; }
        
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: none;
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            max-width: 500px; 
            width: 90%; 
            margin: 1rem;
        }
        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }
        
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        
        .alert { 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            margin-bottom: 1rem; 
            border-left: 4px solid;
        }
        .alert-warning { background: #fefce8; border-color: #f59e0b; color: #92400e; }
        .alert-success { background: #f0fdf4; border-color: #10b981; color: #065f46; }
        
        .text-center { text-align: center; }
        .text-gray { color: #6b7280; }
        .text-lg { font-size: 1.125rem; }
        .font-bold { font-weight: 700; }
        .mb-4 { margin-bottom: 1rem; }
        .py-8 { padding: 2rem 0; }
        
        .hidden { display: none; }
        
        .edit-task-form {
            width: 100%;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .nav { flex-wrap: wrap; }
            .radio-group { flex-direction: column; gap: 0.5rem; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 class="text-lg font-bold">Multi-Business Task Manager</h1>
                <div style="font-size: 0.875rem; color: #6b7280;">üì± Offline Mode</div>
            </div>
            <div class="nav">
                <button class="nav-btn active" onclick="showView('capture')" id="capture-btn">üìù Capture & Organize</button>
                <button class="nav-btn" onclick="showView('daily')" id="daily-btn">üéØ Daily Focus</button>
                <button class="nav-btn" onclick="showView('completed')" id="completed-btn">üìä Completed Tasks</button>
                <button class="nav-btn" onclick="showView('sms')" id="sms-btn">üì± SMS Setup</button>
                <button class="nav-btn" onclick="exportTasks()" title="Download backup">üíæ Download Backup</button>
            </div>
        </div>
        
        <div id="capture-view">
            <div class="card">
                <h2 class="font-bold mb-4">Quick Capture</h2>
                
                <div class="input-group">
                    <div class="input-container">
                        <input type="text" id="task-input" class="text-input" 
                               placeholder='Enter your task here... (use @category or @priority)' 
                               onkeydown="handleTaskInput(event)" 
                               oninput="handleSmartInput(event)">
                        <div id="suggestions-dropdown" class="suggestions-dropdown"></div>
                    </div>
                </div>
                
                <div id="edit-categories" class="edit-section">
                    <div class="edit-header">
                        <h4>Edit Categories</h4>
                        <button class="btn btn-sm btn-secondary" onclick="toggleEditCategories()">Done</button>
                    </div>
                    <div class="edit-items" id="categories-list"></div>
                    <div class="add-item-form">
                        <input type="text" id="new-category-input" class="add-item-input" placeholder="Add new category">
                        <button class="btn btn-sm btn-primary" onclick="addCategory()">Add</button>
                    </div>
                </div>
                
                <div id="edit-priorities" class="edit-section">
                    <div class="edit-header">
                        <h4>Edit Priorities</h4>
                        <button class="btn btn-sm btn-secondary" onclick="toggleEditPriorities()">Done</button>
                    </div>
                    <div class="edit-items" id="priorities-list"></div>
                    <div class="add-item-form">
                        <input type="text" id="new-priority-input" class="add-item-input" placeholder="Add new priority">
                        <button class="btn btn-sm btn-primary" onclick="addPriority()">Add</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>
                        Category
                        <button class="icon-btn" onclick="toggleEditCategories()" title="Edit categories">‚úèÔ∏è</button>
                    </label>
                    <div class="radio-group" id="category-options"></div>
                </div>
                
                <div class="input-group">
                    <label>
                        Priority
                        <button class="icon-btn" onclick="toggleEditPriorities()" title="Edit priorities">‚úèÔ∏è</button>
                    </label>
                    <div class="radio-group" id="priority-options"></div>
                </div>
                
                <button class="btn btn-primary" onclick="addTask()">‚ûï Add Task</button>
            </div>
            
            <div class="card">
                <h2 class="font-bold mb-4">All Tasks (<span id="total-tasks">0</span>)</h2>
                <div id="tasks-container">
                    <p class="text-center text-gray py-8">No tasks yet. Start capturing your thoughts above!</p>
                </div>
            </div>
        </div>
        
        <div id="daily-view" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 class="font-bold">Today's Focus (<span id="daily-count">0</span>/10 active ‚Ä¢ <span id="completed-count">0</span> completed)</h2>
                    <div class="text-gray" id="current-date"></div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="showAddTasksModal()">Add Tasks</button>
                </div>
                
                <div id="daily-limit-warning" class="alert alert-warning hidden">
                    üìã You have already reached your daily focus task limit (10 tasks)
                </div>
                
                <div id="rollover-section" class="hidden">
                    <div class="alert" style="background: #fef3c7; border-color: #f59e0b; color: #92400e; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 class="font-bold">üìÖ Uncompleted Tasks from Previous Days</h4>
                            <button class="btn btn-sm btn-primary" onclick="rolloverAllTasks()">Roll Over All</button>
                        </div>
                        <div id="rollover-tasks-list"></div>
                    </div>
                </div>
                
                <div id="daily-tasks-container">
                    <div class="text-center py-8">
                        <p class="text-gray mb-4">No tasks selected for today.</p>
                        <button class="btn btn-primary" onclick="showAddTasksModal()">Add Tasks</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="completed-view" class="hidden">
            <div class="card">
                <h2 class="font-bold mb-4">üìä Completed Tasks History</h2>
                <div id="completed-tasks-container">
                    <p class="text-center text-gray py-8">No completed tasks yet.</p>
                </div>
            </div>
        </div>

        <div id="sms-view" class="hidden">
            <div class="card">
                <h2 class="font-bold mb-4">üì± SMS Task Creation</h2>
                
                <div class="alert" style="background: #eff6ff; border-color: #3b82f6; color: #1e40af; margin-bottom: 1.5rem;">
                    <h3 class="font-bold mb-2">üìß Email-to-SMS Gateway Setup</h3>
                    <p>Send emails to your carrier's SMS gateway to create tasks instantly from your phone!</p>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <h3 class="font-bold mb-2">üîß Setup Instructions:</h3>
                    <ol style="margin-left: 1.5rem; line-height: 1.8;">
                        <li><strong>Find your carrier's email gateway:</strong></li>
                        <ul style="margin: 0.5rem 0 1rem 1rem; color: #6b7280;">
                            <li>Verizon: <code>yournumber@vtext.com</code></li>
                            <li>AT&T: <code>yournumber@txt.att.net</code></li>
                            <li>T-Mobile: <code>yournumber@tmomail.net</code></li>
                            <li>Sprint: <code>yournumber@messaging.sprintpcs.com</code></li>
                        </ul>
                        <li><strong>Set up email forwarding</strong> from that address to this app</li>
                        <li><strong>Send a test email</strong> to verify the connection</li>
                    </ol>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <h3 class="font-bold mb-2">üìù Message Format:</h3>
                    <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; font-family: monospace;">
                        <div style="margin-bottom: 0.5rem;"><strong>Examples:</strong></div>
                        <div style="color: #059669; margin-bottom: 0.25rem;">@strategylabs @high Call client about proposal</div>
                        <div style="color: #dc2626; margin-bottom: 0.25rem;">Buy groceries @personal @low</div>
                        <div style="color: #7c3aed;">@unomas @medium Check inventory for weekend</div>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <h3 class="font-bold mb-2">üìß Email Processing</h3>
                    <p style="margin-bottom: 1rem; color: #6b7280;">Paste email content below to simulate SMS task creation:</p>
                    
                    <textarea id="email-content" class="text-input" rows="4" placeholder="Paste email content here to test SMS parsing..."></textarea>
                    
                    <button class="btn btn-primary" onclick="processEmailContent()" style="margin-top: 0.5rem;">
                        üìß Process Email & Create Tasks
                    </button>
                </div>

                <div id="sms-results" style="display: none;">
                    <h3 class="font-bold mb-2">‚úÖ Processing Results:</h3>
                    <div id="sms-results-content"></div>
                </div>

                <div style="margin-top: 2rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem; border-left: 4px solid #f59e0b;">
                    <h4 class="font-bold mb-1">üí° Pro Tips:</h4>
                    <ul style="margin-left: 1.5rem; color: #92400e;">
                        <li>Use @ mentions for category and priority</li>
                        <li>Keep messages short for SMS character limits</li>
                        <li>Multiple tasks can be separated by line breaks</li>
                        <li>Tasks without @ mentions default to Personal/Medium</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="add-tasks-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold mb-4">Add Tasks to Daily Focus</h3>
            <div id="add-tasks-warning" class="alert alert-warning hidden">
                You have already reached your daily focus task limit (10 tasks)
            </div>
            <div id="add-tasks-list"></div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="addSelectedTasks()">Add Selected Tasks</button>
                <button class="btn btn-secondary" onclick="hideAddTasksModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="completion-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold mb-4">Daily Review</h3>
            <p id="completion-message" class="mb-4"></p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="clearCompleted()">Clear Completed & Add New Tasks</button>
                <button class="btn btn-secondary" onclick="hideCompletionModal()">Keep All Tasks</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let tasks = [];
        let dailyTasks = [];
        let completedTasksHistory = []; // New: track completed tasks with dates
        let currentView = 'capture';
        let editingTaskId = null; // Track which task is being edited
        
        // Customizable categories and priorities
        let categories = {
            personal: { name: 'Personal', badge: 'badge-personal' },
            strategylabs: { name: 'Strategy Labs', badge: 'badge-strategylabs' },
            unomas: { name: 'Uno Mas', badge: 'badge-unomas' }
        };
        
        let priorities = ['high', 'medium', 'low'];
        
        // Smart input state
        let isShowingSuggestions = false;
        let currentSuggestions = [];
        let activeSuggestionIndex = -1;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            updateCurrentDate();
            populateCategoryOptions();
            populatePriorityOptions();
            renderTasks();
            renderDailyTasks();
            
            // Make functions globally available for onclick handlers
            window.showAddTasksModal = showAddTasksModal;
            window.hideAddTasksModal = hideAddTasksModal;
            window.addSelectedTasks = addSelectedTasks;
            window.toggleAddTasksCategory = toggleAddTasksCategory;
            window.checkForRolloverTasks = checkForRolloverTasks;
            window.rolloverAllTasks = rolloverAllTasks;
            window.rolloverSingleTask = rolloverSingleTask;
            window.completeTask = completeTask;
            window.uncompleteTask = uncompleteTask;
            window.duplicateTask = duplicateTask;
            window.editTask = editTask;
            window.saveTaskEdit = saveTaskEdit;
            window.cancelTaskEdit = cancelTaskEdit;
            window.toggleCompletedDate = toggleCompletedDate;
        });

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = dateStr;
            }
        }

        function showView(view) {
            currentView = view;
            document.getElementById('capture-view').className = view === 'capture' ? '' : 'hidden';
            document.getElementById('daily-view').className = view === 'daily' ? '' : 'hidden';
            document.getElementById('completed-view').className = view === 'completed' ? '' : 'hidden';
            document.getElementById('sms-view').className = view === 'sms' ? '' : 'hidden';
            
            document.getElementById('capture-btn').className = view === 'capture' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('daily-btn').className = view === 'daily' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('completed-btn').className = view === 'completed' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('sms-btn').className = view === 'sms' ? 'nav-btn active' : 'nav-btn';
            
            if (view === 'daily') {
                updateDailyView();
                checkForRolloverTasks();
            } else if (view === 'completed') {
                renderCompletedTasksHistory();
            }
        }

        function handleTaskInput(event) {
            if (event.key === 'Enter') {
                if (isShowingSuggestions && activeSuggestionIndex >= 0) {
                    event.preventDefault();
                    selectSuggestion(currentSuggestions[activeSuggestionIndex]);
                } else {
                    addTask();
                }
            } else if (event.key === 'ArrowDown') {
                if (isShowingSuggestions) {
                    event.preventDefault();
                    navigateSuggestions(1);
                }
            } else if (event.key === 'ArrowUp') {
                if (isShowingSuggestions) {
                    event.preventDefault();
                    navigateSuggestions(-1);
                }
            } else if (event.key === 'Tab') {
                if (isShowingSuggestions && activeSuggestionIndex >= 0) {
                    event.preventDefault();
                    selectSuggestion(currentSuggestions[activeSuggestionIndex]);
                }
            } else if (event.key === 'Escape') {
                hideSuggestions();
            }
        }

        function handleSmartInput(event) {
            const input = event.target;
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // Find @ mentions
            const beforeCursor = text.substring(0, cursorPos);
            const atMatch = beforeCursor.match(/@(\w*)$/);
            
            if (atMatch) {
                const searchTerm = atMatch[1].toLowerCase();
                showSuggestions(searchTerm, cursorPos - atMatch[0].length);
            } else {
                hideSuggestions();
            }
        }

        function showSuggestions(searchTerm) {
            const suggestions = [];
            
            // Add category suggestions
            Object.entries(categories).forEach(([key, category]) => {
                if (category.name.toLowerCase().includes(searchTerm)) {
                    suggestions.push({
                        type: 'category',
                        key: key,
                        display: category.name,
                        value: `@${category.name.toLowerCase().replace(/\s+/g, '')}`
                    });
                }
            });
            
            // Add priority suggestions
            priorities.forEach(priority => {
                if (priority.toLowerCase().includes(searchTerm)) {
                    suggestions.push({
                        type: 'priority',
                        key: priority,
                        display: priority.charAt(0).toUpperCase() + priority.slice(1),
                        value: `@${priority}`
                    });
                }
            });
            
            if (suggestions.length > 0) {
                currentSuggestions = suggestions;
                activeSuggestionIndex = 0;
                isShowingSuggestions = true;
                renderSuggestions();
            } else {
                hideSuggestions();
            }
        }

        function renderSuggestions() {
            const dropdown = document.getElementById('suggestions-dropdown');
            
            const html = currentSuggestions.map((suggestion, index) => `
                <div class="suggestion-item ${index === activeSuggestionIndex ? 'active' : ''}" 
                     onclick="selectSuggestion(currentSuggestions[${index}])">
                    <span class="suggestion-type">${suggestion.type}:</span>
                    <span>${suggestion.display}</span>
                </div>
            `).join('');
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function navigateSuggestions(direction) {
            if (currentSuggestions.length === 0) return;
            
            activeSuggestionIndex += direction;
            if (activeSuggestionIndex < 0) activeSuggestionIndex = currentSuggestions.length - 1;
            if (activeSuggestionIndex >= currentSuggestions.length) activeSuggestionIndex = 0;
            
            renderSuggestions();
        }

        function selectSuggestion(suggestion) {
            const input = document.getElementById('task-input');
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // Find the @ mention to replace
            const beforeCursor = text.substring(0, cursorPos);
            const atMatch = beforeCursor.match(/@(\w*)$/);
            
            if (atMatch) {
                const newText = text.substring(0, cursorPos - atMatch[0].length) + 
                               suggestion.value + ' ' + 
                               text.substring(cursorPos);
                input.value = newText;
                
                // Set cursor position after the replacement
                const newCursorPos = cursorPos - atMatch[0].length + suggestion.value.length + 1;
                input.setSelectionRange(newCursorPos, newCursorPos);
                
                // Auto-select the corresponding radio button
                if (suggestion.type === 'category') {
                    const categoryRadio = document.querySelector(`input[name="category"][value="${suggestion.key}"]`);
                    if (categoryRadio) categoryRadio.checked = true;
                } else if (suggestion.type === 'priority') {
                    const priorityRadio = document.querySelector(`input[name="priority"][value="${suggestion.key}"]`);
                    if (priorityRadio) priorityRadio.checked = true;
                }
            }
            
            hideSuggestions();
            input.focus();
        }

        function hideSuggestions() {
            setTimeout(() => {
                isShowingSuggestions = false;
                currentSuggestions = [];
                activeSuggestionIndex = -1;
                document.getElementById('suggestions-dropdown').style.display = 'none';
            }, 150);
        }

        function populateCategoryOptions() {
            const container = document.getElementById('category-options');
            let html = '';
            let isFirst = true;
            
            Object.entries(categories).forEach(([key, category]) => {
                html += `
                    <label class="radio-item">
                        <input type="radio" name="category" value="${key}" ${isFirst ? 'checked' : ''}>
                        <span>${category.name}</span>
                    </label>
                `;
                isFirst = false;
            });
            
            container.innerHTML = html;
        }

        function populatePriorityOptions() {
            const container = document.getElementById('priority-options');
            let html = '';
            
            priorities.forEach((priority, index) => {
                html += `
                    <label class="radio-item">
                        <input type="radio" name="priority" value="${priority}" ${index === 1 ? 'checked' : ''}>
                        <span class="badge badge-${priority}">${priority.charAt(0).toUpperCase() + priority.slice(1)}</span>
                    </label>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleEditCategories() {
            const editSection = document.getElementById('edit-categories');
            const isHidden = !editSection.classList.contains('show');
            
            if (isHidden) {
                editSection.classList.add('show');
                renderEditableCategories();
            } else {
                editSection.classList.remove('show');
                populateCategoryOptions();
                saveToStorage();
            }
        }

        function toggleEditPriorities() {
            const editSection = document.getElementById('edit-priorities');
            const isHidden = !editSection.classList.contains('show');
            
            if (isHidden) {
                editSection.classList.add('show');
                renderEditablePriorities();
            } else {
                editSection.classList.remove('show');
                populatePriorityOptions();
                saveToStorage();
            }
        }

        function renderEditableCategories() {
            const container = document.getElementById('categories-list');
            let html = '';
            
            Object.entries(categories).forEach(([key, category]) => {
                html += `
                    <div class="edit-item">
                        <span>${category.name}</span>
                        <button onclick="deleteCategory('${key}')" title="Delete category">√ó</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderEditablePriorities() {
            const container = document.getElementById('priorities-list');
            let html = '';
            
            priorities.forEach((priority, index) => {
                html += `
                    <div class="edit-item">
                        <span class="badge badge-${priority}">${priority.charAt(0).toUpperCase() + priority.slice(1)}</span>
                        ${priorities.length > 1 ? `<button onclick="deletePriority(${index})" title="Delete priority">√ó</button>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function addCategory() {
            const input = document.getElementById('new-category-input');
            const name = input.value.trim();
            
            if (!name) return;
            
            const key = name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
            
            if (!categories[key]) {
                categories[key] = {
                    name: name,
                    badge: `badge-${key}`
                };
                
                input.value = '';
                renderEditableCategories();
                addDynamicCSS(key);
            }
        }

        function addPriority() {
            const input = document.getElementById('new-priority-input');
            const priority = input.value.trim().toLowerCase();
            
            if (!priority || priorities.includes(priority)) return;
            
            priorities.push(priority);
            input.value = '';
            renderEditablePriorities();
            addDynamicCSS(priority, true);
        }

        function deleteCategory(key) {
            if (Object.keys(categories).length <= 1) {
                alert('You must have at least one category.');
                return;
            }
            
            if (confirm(`Delete category "${categories[key].name}"?`)) {
                delete categories[key];
                renderEditableCategories();
            }
        }

        function deletePriority(index) {
            if (priorities.length <= 1) {
                alert('You must have at least one priority.');
                return;
            }
            
            if (confirm(`Delete priority "${priorities[index]}"?`)) {
                priorities.splice(index, 1);
                renderEditablePriorities();
            }
        }

        function addDynamicCSS(key, isPriority = false) {
            let styleSheet = document.getElementById('dynamic-styles');
            if (!styleSheet) {
                styleSheet = document.createElement('style');
                styleSheet.id = 'dynamic-styles';
                document.head.appendChild(styleSheet);
            }
            
            if (isPriority) {
                const colors = ['#fef2f2', '#fefce8', '#f0fdf4', '#eff6ff'];
                const textColors = ['#991b1b', '#a16207', '#065f46', '#1e40af'];
                const colorIndex = priorities.length % colors.length;
                
                styleSheet.sheet.insertRule(`.badge-${key} { background: ${colors[colorIndex]}; color: ${textColors[colorIndex]}; }`, styleSheet.sheet.cssRules.length);
            } else {
                const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#8b5cf6', '#ec4899'];
                const color = colors[Object.keys(categories).length % colors.length];
                
                styleSheet.sheet.insertRule(`.badge-${key} { background: ${color}; color: white; }`, styleSheet.sheet.cssRules.length);
                styleSheet.sheet.insertRule(`.task-item.${key} { border-color: ${color}40; background: ${color}10; }`, styleSheet.sheet.cssRules.length);
            }
        }

        function addTask() {
            const input = document.getElementById('task-input');
            let text = input.value.trim();
            
            if (!text) return;
            
            let selectedCategory = null;
            let selectedPriority = null;
            
            // Parse @ mentions and remove them from task text
            const atMentions = text.match(/@\w+/g) || [];
            
            atMentions.forEach(mention => {
                const mentionText = mention.substring(1).toLowerCase();
                
                // Check if it matches a category
                Object.entries(categories).forEach(([key, category]) => {
                    if (category.name.toLowerCase().replace(/\s+/g, '') === mentionText ||
                        key === mentionText) {
                        selectedCategory = key;
                    }
                });
                
                // Check if it matches a priority
                priorities.forEach(priority => {
                    if (priority.toLowerCase() === mentionText) {
                        selectedPriority = priority;
                    }
                });
                
                // Remove the @ mention from the text
                text = text.replace(mention, '').trim();
            });
            
            // Clean up multiple spaces
            text = text.replace(/\s+/g, ' ').trim();
            
            if (!text) return; // Don't create empty tasks
            
            // Use parsed values or fall back to selected radio buttons
            const categoryEl = document.querySelector('input[name="category"]:checked');
            const priorityEl = document.querySelector('input[name="priority"]:checked');
            
            const finalCategory = selectedCategory || (categoryEl ? categoryEl.value : 'personal');
            const finalPriority = selectedPriority || (priorityEl ? priorityEl.value : 'medium');
            
            // Update radio buttons to match parsed values
            if (selectedCategory) {
                const categoryRadio = document.querySelector(`input[name="category"][value="${selectedCategory}"]`);
                if (categoryRadio) categoryRadio.checked = true;
            }
            if (selectedPriority) {
                const priorityRadio = document.querySelector(`input[name="priority"][value="${selectedPriority}"]`);
                if (priorityRadio) priorityRadio.checked = true;
            }
            
            const task = {
                id: Date.now(),
                text: text,
                category: finalCategory,
                priority: finalPriority,
                completed: false,
                createdAt: new Date()
            };
            
            tasks.unshift(task);
            input.value = '';
            saveToStorage();
            renderTasks();
        }

        function deleteTask(id) {
            tasks = tasks.filter(task => task.id !== id);
            dailyTasks = dailyTasks.filter(task => task.id !== id);
            saveToStorage();
            renderTasks();
            renderDailyTasks();
        }

        function toggleTask(id) {
            const task = tasks.find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    // Add to completed history when task is completed
                    addToCompletedHistory(task);
                }
                renderTasks();
            }
            
            const dailyTask = dailyTasks.find(task => task.id === id);
            if (dailyTask) {
                dailyTask.completed = !dailyTask.completed;
                dailyTask.completedDate = dailyTask.completed ? new Date().toISOString() : null;
                
                if (dailyTask.completed) {
                    // Add to completed history when daily task is completed
                    addToCompletedHistory(dailyTask);
                }
                
                renderDailyTasks();
                checkDailyLimit();
            }
            
            saveToStorage();
        }

        function addToCompletedHistory(task) {
            const completedTask = {
                ...task,
                completedDate: new Date().toISOString(),
                originalCompletedDate: task.completedDate || new Date().toISOString()
            };
            
            // Avoid duplicates
            const existingIndex = completedTasksHistory.findIndex(ct => ct.id === task.id);
            if (existingIndex >= 0) {
                completedTasksHistory[existingIndex] = completedTask;
            } else {
                completedTasksHistory.unshift(completedTask);
            }
        }

        function addToDaily(id) {
            const task = tasks.find(task => task.id === id);
            const activeDailyTasks = dailyTasks.filter(t => !t.completed);
            
            if (task && activeDailyTasks.length < 10 && !dailyTasks.find(t => t.id === id)) {
                dailyTasks.push({...task});
                saveToStorage();
                renderDailyTasks();
                updateDailyView();
            }
        }

        function completeTask(id) {
            const dailyTask = dailyTasks.find(task => task.id === id);
            if (dailyTask && !dailyTask.completed) {
                dailyTask.completed = true;
                dailyTask.completedDate = new Date().toISOString();
                
                // Add to completed history
                addToCompletedHistory(dailyTask);
                
                // Also mark the main task as completed
                const mainTask = tasks.find(task => task.id === id);
                if (mainTask) {
                    mainTask.completed = true;
                }
                
                saveToStorage();
                renderDailyTasks();
                renderTasks();
                updateDailyView();
                
                // Don't show completion modal - just keep the task visible with strikethrough
            }
        }

        function duplicateTask(id) {
            const taskToDuplicate = tasks.find(task => task.id === id) || dailyTasks.find(task => task.id === id);
            
            if (taskToDuplicate) {
                const duplicatedTask = {
                    id: Date.now(),
                    text: taskToDuplicate.text + ' (Copy)',
                    category: taskToDuplicate.category,
                    priority: taskToDuplicate.priority,
                    completed: false, // Always create duplicates as incomplete
                    createdAt: new Date()
                };
                
                // Add to main tasks list
                tasks.unshift(duplicatedTask);
                
                saveToStorage();
                renderTasks();
                
                // Show feedback
                const notification = document.createElement('div');
                notification.innerHTML = 'üìã Task duplicated successfully!';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 0.75rem 1rem;
                    border-radius: 0.5rem;
                    z-index: 1000;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    font-weight: 500;
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 2000);
            }
        }

        function removeFromDaily(id) {
            if (confirm('Remove this task from today\'s focus? It will return to your main task list.')) {
                dailyTasks = dailyTasks.filter(task => task.id !== id);
                saveToStorage();
                renderDailyTasks();
                updateDailyView();
            }
        }

        function editTask(id) {
            // Cancel any existing edit
            if (editingTaskId !== null) {
                cancelTaskEdit();
            }
            
            editingTaskId = id;
            renderTasks();
            renderDailyTasks();
            
            // Focus on the text input
            setTimeout(() => {
                const textInput = document.getElementById(`edit-text-${id}`);
                if (textInput) {
                    textInput.focus();
                    textInput.select();
                }
            }, 50);
        }

        function saveTaskEdit(id) {
            const textInput = document.getElementById(`edit-text-${id}`);
            const categorySelect = document.getElementById(`edit-category-${id}`);
            const prioritySelect = document.getElementById(`edit-priority-${id}`);
            
            if (!textInput || !categorySelect || !prioritySelect) return;
            
            const newText = textInput.value.trim();
            const newCategory = categorySelect.value;
            const newPriority = prioritySelect.value;
            
            if (!newText) {
                alert('Task name cannot be empty!');
                textInput.focus();
                return;
            }
            
            // Update main task
            const mainTask = tasks.find(task => task.id === id);
            if (mainTask) {
                mainTask.text = newText;
                mainTask.category = newCategory;
                mainTask.priority = newPriority;
            }
            
            // Update daily task if it exists
            const dailyTask = dailyTasks.find(task => task.id === id);
            if (dailyTask) {
                dailyTask.text = newText;
                dailyTask.category = newCategory;
                dailyTask.priority = newPriority;
            }
            
            // Update completed history if it exists
            const completedTask = completedTasksHistory.find(task => task.id === id);
            if (completedTask) {
                completedTask.text = newText;
                completedTask.category = newCategory;
                completedTask.priority = newPriority;
            }
            
            editingTaskId = null;
            saveToStorage();
            renderTasks();
            renderDailyTasks();
            
            // Show success notification
            const notification = document.createElement('div');
            notification.innerHTML = '‚úèÔ∏è Task updated successfully!';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                font-weight: 500;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 2000);
        }

        function cancelTaskEdit() {
            editingTaskId = null;
            renderTasks();
            renderDailyTasks();
        }

        function uncompleteTask(id) {
            const dailyTask = dailyTasks.find(task => task.id === id);
            if (dailyTask && dailyTask.completed) {
                dailyTask.completed = false;
                dailyTask.completedDate = null;
                
                // Also mark the main task as incomplete
                const mainTask = tasks.find(task => task.id === id);
                if (mainTask) {
                    mainTask.completed = false;
                }
                
                // Remove from completed history
                completedTasksHistory = completedTasksHistory.filter(ct => ct.id !== id);
                
                saveToStorage();
                renderDailyTasks();
                renderTasks();
                updateDailyView();
                
                // Show feedback
                const notification = document.createElement('div');
                notification.innerHTML = 'üîÑ Task marked as incomplete!';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f59e0b;
                    color: white;
                    padding: 0.75rem 1rem;
                    border-radius: 0.5rem;
                    z-index: 1000;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    font-weight: 500;
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 2000);
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('taskManagerTasks', JSON.stringify(tasks));
                localStorage.setItem('taskManagerDailyTasks', JSON.stringify(dailyTasks));
                localStorage.setItem('taskManagerCompletedHistory', JSON.stringify(completedTasksHistory));
                localStorage.setItem('taskManagerCategories', JSON.stringify(categories));
                localStorage.setItem('taskManagerPriorities', JSON.stringify(priorities));
                localStorage.setItem('taskManagerLastSave', new Date().toISOString());
            } catch (error) {
                console.warn('Could not save to localStorage:', error);
            }
        }

        function loadFromStorage() {
            try {
                const savedCategories = localStorage.getItem('taskManagerCategories');
                const savedPriorities = localStorage.getItem('taskManagerPriorities');
                const savedTasks = localStorage.getItem('taskManagerTasks');
                const savedDailyTasks = localStorage.getItem('taskManagerDailyTasks');
                const savedCompletedHistory = localStorage.getItem('taskManagerCompletedHistory');
                
                if (savedCategories) {
                    categories = JSON.parse(savedCategories);
                }
                
                if (savedPriorities) {
                    priorities = JSON.parse(savedPriorities);
                }
                
                if (savedTasks) {
                    tasks = JSON.parse(savedTasks);
                    tasks.forEach(task => {
                        if (task.createdAt) task.createdAt = new Date(task.createdAt);
                    });
                }
                
                if (savedDailyTasks) {
                    dailyTasks = JSON.parse(savedDailyTasks);
                    dailyTasks.forEach(task => {
                        if (task.createdAt) task.createdAt = new Date(task.createdAt);
                    });
                }
                
                if (savedCompletedHistory) {
                    completedTasksHistory = JSON.parse(savedCompletedHistory);
                }
                
                checkNewDay();
            } catch (error) {
                console.warn('Could not load from localStorage:', error);
                tasks = [];
                dailyTasks = [];
                completedTasksHistory = [];
            }
        }

        function checkNewDay() {
            const lastSave = localStorage.getItem('taskManagerLastSave');
            if (lastSave) {
                const lastSaveDate = new Date(lastSave);
                const today = new Date();
                
                if (lastSaveDate.toDateString() !== today.toDateString()) {
                    // Store previous day's daily tasks for rollover
                    localStorage.setItem('taskManagerPreviousDailyTasks', JSON.stringify(dailyTasks));
                    
                    // Reset daily tasks for new day
                    dailyTasks = [];
                    saveToStorage();
                }
            }
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            const totalTasks = tasks.length;
            
            document.getElementById('total-tasks').textContent = totalTasks;
            
            if (totalTasks === 0) {
                container.innerHTML = '<p class="text-center text-gray py-8">No tasks yet. Start capturing your thoughts above!</p>';
                return;
            }
            
            const tasksByCategory = {};
            Object.keys(categories).forEach(key => {
                tasksByCategory[key] = tasks.filter(task => task.category === key);
            });
            
            let html = '';
            Object.entries(tasksByCategory).forEach(([categoryKey, categoryTasks]) => {
                if (categoryTasks.length === 0) return;
                
                html += `
                    <div class="category-section">
                        <div class="category-header" onclick="toggleCategory('${categoryKey}')">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: ${getCategoryColor(categoryKey)};"></span>
                                <span class="font-bold">${categories[categoryKey].name} (${categoryTasks.length})</span>
                            </div>
                            <span id="chevron-${categoryKey}">‚ñº</span>
                        </div>
                        <div class="category-content" id="content-${categoryKey}">
                            ${categoryTasks.map(task => renderTaskItem(task, true)).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderDailyTasks() {
            const container = document.getElementById('daily-tasks-container');
            const activeTasks = dailyTasks.filter(task => !task.completed);
            const completedTasks = dailyTasks.filter(task => task.completed);
            
            document.getElementById('daily-count').textContent = activeTasks.length;
            document.getElementById('completed-count').textContent = completedTasks.length;
            
            if (dailyTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray mb-4">No tasks selected for today.</p>
                        <button class="btn btn-primary" onclick="showAddTasksModal()">Add Tasks</button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Show all tasks together - completed and active
            const tasksByCategory = {};
            Object.keys(categories).forEach(key => {
                tasksByCategory[key] = dailyTasks.filter(task => task.category === key);
            });
            
            html += '<div class="grid grid-2">';
            Object.entries(tasksByCategory).forEach(([categoryKey, categoryTasks]) => {
                if (categoryTasks.length === 0) return;
                
                const activeCount = categoryTasks.filter(t => !t.completed).length;
                const completedCount = categoryTasks.filter(t => t.completed).length;
                
                html += `
                    <div>
                        <h3 class="font-bold mb-4" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: ${getCategoryColor(categoryKey)};"></span>
                            ${categories[categoryKey].name} (${activeCount} active${completedCount > 0 ? `, ${completedCount} done` : ''})
                        </h3>
                        ${categoryTasks.map(task => renderTaskItem(task, false, true)).join('')}
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function renderTaskItem(task, showAddButton = false, fromDaily = false) {
            const activeDailyCount = dailyTasks.filter(t => !t.completed).length;
            const canAddToDaily = activeDailyCount < 10 && !dailyTasks.find(t => t.id === task.id);
            const isEditing = editingTaskId === task.id;
            
            return `
                <div class="task-item ${task.category}">
                    <div class="checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '‚úì' : ''}
                    </div>
                    <div class="task-content">
                        ${isEditing ? `
                            <div class="edit-task-form">
                                <input type="text" id="edit-text-${task.id}" value="${task.text}" class="text-input" style="margin-bottom: 0.5rem;" placeholder="Task name...">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <select id="edit-category-${task.id}" class="add-item-input" style="flex: 1; min-width: 120px;">
                                        ${Object.entries(categories).map(([key, cat]) => 
                                            `<option value="${key}" ${task.category === key ? 'selected' : ''}>${cat.name}</option>`
                                        ).join('')}
                                    </select>
                                    <select id="edit-priority-${task.id}" class="add-item-input" style="flex: 1; min-width: 100px;">
                                        ${priorities.map(priority => 
                                            `<option value="${priority}" ${task.priority === priority ? 'selected' : ''}>${priority.charAt(0).toUpperCase() + priority.slice(1)}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-success" onclick="saveTaskEdit(${task.id})" title="Save changes">
                                        üíæ Save
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="cancelTaskEdit()" title="Cancel editing">
                                        ‚ùå Cancel
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                            <div class="task-meta">
                                <span class="badge ${categories[task.category] ? categories[task.category].badge : 'badge-personal'}">${categories[task.category] ? categories[task.category].name : 'Personal'}</span>
                                <span class="badge badge-${task.priority}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                            </div>
                        `}
                    </div>
                    ${!isEditing ? `
                        <div class="task-actions">
                            ${showAddButton && canAddToDaily ? `
                                <button class="icon-btn primary" onclick="addToDaily(${task.id})" title="Add to daily focus">
                                    ‚ûï
                                </button>
                            ` : ''}
                            ${fromDaily ? `
                                ${!task.completed ? `
                                    <button class="btn btn-sm btn-success" onclick="completeTask(${task.id})" title="Mark task as complete">
                                        ‚úÖ Complete
                                    </button>
                                ` : `
                                    <button class="btn btn-sm" onclick="uncompleteTask(${task.id})" title="Mark task as incomplete" style="background: #f59e0b; color: white;">
                                        üîÑ Incomplete
                                    </button>
                                `}
                                <button class="btn btn-sm btn-secondary" onclick="removeFromDaily(${task.id})" title="Remove from daily focus list">
                                    üì§ Remove
                                </button>
                            ` : ''}
                            <button class="icon-btn" onclick="editTask(${task.id})" title="Edit this task">
                                ‚úèÔ∏è
                            </button>
                            <button class="icon-btn" onclick="duplicateTask(${task.id})" title="Create a copy of this task">
                                üìã
                            </button>
                            <button class="icon-btn danger" onclick="deleteTask(${task.id})" title="Delete this task permanently">
                                üóëÔ∏è
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function getCategoryColor(category) {
            const colors = {
                personal: '#3b82f6',
                strategylabs: '#8b5cf6',
                unomas: '#f97316'
            };
            return colors[category] || '#6b7280';
        }

        function toggleCategory(categoryKey) {
            const content = document.getElementById(`content-${categoryKey}`);
            const chevron = document.getElementById(`chevron-${categoryKey}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                chevron.textContent = '‚ñ∂';
            }
        }

        function processEmailContent() {
            const emailContent = document.getElementById('email-content').value.trim();
            
            if (!emailContent) {
                alert('Please paste some email content to process!');
                return;
            }
            
            const results = parseEmailForTasks(emailContent);
            displaySMSResults(results);
            
            // Clear the textarea
            document.getElementById('email-content').value = '';
        }

        function parseEmailForTasks(emailContent) {
            const results = {
                tasksCreated: [],
                errors: [],
                rawContent: emailContent
            };
            
            // Split by lines and clean up
            const lines = emailContent.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            lines.forEach((line, index) => {
                try {
                    // Skip obvious email headers or formatting
                    if (line.includes('@') && (line.includes('.com') || line.includes('From:') || line.includes('To:') || line.includes('Subject:'))) {
                        return; // Skip email headers
                    }
                    
                    // Skip very short lines that are likely not tasks
                    if (line.length < 3) {
                        return;
                    }
                    
                    const task = parseTaskFromText(line);
                    if (task) {
                        // Add SMS indicator
                        task.createdViaSMS = true;
                        task.smsSource = 'Email Gateway';
                        
                        // Add to tasks
                        tasks.unshift(task);
                        results.tasksCreated.push({
                            task: task,
                            originalLine: line
                        });
                    }
                } catch (error) {
                    results.errors.push({
                        line: line,
                        error: error.message
                    });
                }
            });
            
            if (results.tasksCreated.length > 0) {
                saveToStorage();
                renderTasks();
            }
            
            return results;
        }

        function parseTaskFromText(text) {
            let taskText = text.trim();
            let selectedCategory = null;
            let selectedPriority = null;
            
            // Parse @ mentions and remove them from task text
            const atMentions = taskText.match(/@\w+/g) || [];
            
            atMentions.forEach(mention => {
                const mentionText = mention.substring(1).toLowerCase();
                
                // Check if it matches a category
                Object.entries(categories).forEach(([key, category]) => {
                    if (category.name.toLowerCase().replace(/\s+/g, '') === mentionText ||
                        key === mentionText) {
                        selectedCategory = key;
                    }
                });
                
                // Check if it matches a priority
                priorities.forEach(priority => {
                    if (priority.toLowerCase() === mentionText) {
                        selectedPriority = priority;
                    }
                });
                
                // Remove the @ mention from the text
                taskText = taskText.replace(mention, '').trim();
            });
            
            // Clean up multiple spaces
            taskText = taskText.replace(/\s+/g, ' ').trim();
            
            if (!taskText) return null; // Don't create empty tasks
            
            return {
                id: Date.now() + Math.random(), // Ensure unique IDs
                text: taskText,
                category: selectedCategory || 'personal',
                priority: selectedPriority || 'medium',
                completed: false,
                createdAt: new Date()
            };
        }

        function displaySMSResults(results) {
            const resultsDiv = document.getElementById('sms-results');
            const contentDiv = document.getElementById('sms-results-content');
            
            let html = '';
            
            if (results.tasksCreated.length > 0) {
                html += `
                    <div class="alert alert-success" style="margin-bottom: 1rem;">
                        <h4 class="font-bold">‚úÖ Created ${results.tasksCreated.length} task(s):</h4>
                        ${results.tasksCreated.map(item => `
                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 0.25rem;">
                                <div><strong>"${item.task.text}"</strong></div>
                                <div style="font-size: 0.75rem; color: #6b7280;">
                                    <span class="badge ${categories[item.task.category].badge}">${categories[item.task.category].name}</span>
                                    <span class="badge badge-${item.task.priority}" style="margin-left: 0.5rem;">${item.task.priority}</span>
                                    <span style="margin-left: 0.5rem;">üìß via SMS</span>
                                </div>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">
                                    Original: "${item.originalLine}"
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (results.errors.length > 0) {
                html += `
                    <div class="alert" style="background: #fef2f2; border-color: #ef4444; color: #991b1b; margin-bottom: 1rem;">
                        <h4 class="font-bold">‚ö†Ô∏è Errors (${results.errors.length}):</h4>
                        ${results.errors.map(error => `
                            <div style="margin: 0.25rem 0;">"${error.line}" - ${error.error}</div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (results.tasksCreated.length === 0 && results.errors.length === 0) {
                html = `
                    <div class="alert" style="background: #fef3c7; border-color: #f59e0b; color: #92400e;">
                        No tasks found in the provided content. Make sure to include task descriptions with optional @category and @priority tags.
                    </div>
                `;
            }
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function updateDailyView() {
            const activeTasks = dailyTasks.filter(task => !task.completed);
            const warning = document.getElementById('daily-limit-warning');
            
            if (activeTasks.length >= 10) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            renderDailyTasks();
        }

        function checkDailyLimit() {
            // Removed the automatic completion modal
            // Tasks now stay visible with strikethrough when completed
            // This provides better continuity and visual progress tracking
        }

        function showCompletionModal(completed, available) {
            const modal = document.getElementById('completion-modal');
            const message = document.getElementById('completion-message');
            
            message.textContent = `Great job! You completed ${completed} task(s) today. You can now add ${available} more task(s) to your daily focus.`;
            modal.classList.add('show');
        }

        function hideCompletionModal() {
            document.getElementById('completion-modal').classList.remove('show');
        }

        function clearCompleted() {
            dailyTasks = dailyTasks.filter(task => !task.completed);
            saveToStorage();
            hideCompletionModal();
            updateDailyView();
        }

        function exportTasks() {
            const data = {
                tasks: tasks,
                dailyTasks: dailyTasks,
                categories: categories,
                priorities: priorities,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `task-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function showAddTasksModal() {
            console.log('showAddTasksModal called'); // Debug line
            
            const activeDailyTasks = dailyTasks.filter(t => !t.completed);
            const modal = document.getElementById('add-tasks-modal');
            const warning = document.getElementById('add-tasks-warning');
            
            console.log('Active daily tasks:', activeDailyTasks.length); // Debug line
            console.log('Modal element:', modal); // Debug line
            
            if (!modal) {
                console.error('Modal not found!');
                return;
            }
            
            if (activeDailyTasks.length >= 10) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            renderAddTasksList();
            modal.classList.add('show');
        }

        function hideAddTasksModal() {
            document.getElementById('add-tasks-modal').classList.remove('show');
        }

        function renderAddTasksList() {
            const container = document.getElementById('add-tasks-list');
            const availableTasks = tasks.filter(task => 
                !task.completed && !dailyTasks.find(dt => dt.id === task.id)
            );
            
            if (availableTasks.length === 0) {
                container.innerHTML = '<p class="text-gray text-center py-4">No available tasks to add.</p>';
                return;
            }
            
            // Group tasks by category
            const tasksByCategory = {};
            Object.keys(categories).forEach(key => {
                tasksByCategory[key] = availableTasks.filter(task => task.category === key);
            });
            
            let html = '';
            
            Object.entries(tasksByCategory).forEach(([categoryKey, categoryTasks]) => {
                if (categoryTasks.length === 0) return;
                
                html += `
                    <div class="category-section" style="margin-bottom: 1rem;">
                        <div class="category-header" onclick="toggleAddTasksCategory('${categoryKey}')" style="cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: ${getCategoryColor(categoryKey)};"></span>
                                <span class="font-bold">${categories[categoryKey].name} (${categoryTasks.length})</span>
                            </div>
                            <span id="add-chevron-${categoryKey}">‚ñº</span>
                        </div>
                        <div class="category-content" id="add-content-${categoryKey}" style="padding: 0.75rem;">
                            ${categoryTasks.map(task => `
                                <label class="radio-item" style="display: flex; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="selected-tasks" value="${task.id}" style="margin-top: 0.25rem;">
                                    <div>
                                        <div style="font-weight: 500;">${task.text}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280;">
                                            <span class="badge badge-${task.priority}" style="margin-right: 0.5rem;">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                                        </div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleAddTasksCategory(categoryKey) {
            const content = document.getElementById(`add-content-${categoryKey}`);
            const chevron = document.getElementById(`add-chevron-${categoryKey}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                chevron.textContent = '‚ñ∂';
            }
        }

        function addSelectedTasks() {
            const activeDailyTasks = dailyTasks.filter(t => !t.completed);
            const selectedCheckboxes = document.querySelectorAll('input[name="selected-tasks"]:checked');
            const selectedTaskIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            
            if (selectedTaskIds.length === 0) {
                alert('Please select at least one task to add.');
                return;
            }
            
            if (activeDailyTasks.length + selectedTaskIds.length > 10) {
                alert(`You can only add ${10 - activeDailyTasks.length} more task(s) to reach the daily limit of 10.`);
                return;
            }
            
            selectedTaskIds.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task && !dailyTasks.find(dt => dt.id === taskId)) {
                    dailyTasks.push({...task});
                }
            });
            
            saveToStorage();
            renderDailyTasks();
            updateDailyView();
            hideAddTasksModal();
        }

        function checkForRolloverTasks() {
            const today = new Date().toDateString();
            const previousDailyTasks = JSON.parse(localStorage.getItem('taskManagerPreviousDailyTasks') || '[]');
            
            // Find uncompleted tasks from previous days
            const rolloverTasks = previousDailyTasks.filter(task => 
                !task.completed && 
                new Date(task.addedToDaily || task.createdAt).toDateString() !== today
            );
            
            const rolloverSection = document.getElementById('rollover-section');
            
            if (rolloverTasks.length > 0) {
                rolloverSection.classList.remove('hidden');
                renderRolloverTasks(rolloverTasks);
            } else {
                rolloverSection.classList.add('hidden');
            }
        }

        function renderRolloverTasks(rolloverTasks) {
            const container = document.getElementById('rollover-tasks-list');
            
            let html = '';
            rolloverTasks.forEach(task => {
                const daysAgo = Math.floor((new Date() - new Date(task.addedToDaily || task.createdAt)) / (1000 * 60 * 60 * 24));
                html += `
                    <div style="display: flex; justify-content: between; align-items: center; padding: 0.5rem; background: white; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>${task.text}</strong>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                <span class="badge badge-${task.category}" style="margin-right: 0.5rem;">${categories[task.category]?.name || 'Unknown'}</span>
                                <span class="badge badge-${task.priority}">${task.priority}</span>
                                <span style="margin-left: 0.5rem;">${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago</span>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="rolloverSingleTask(${task.id})" style="margin-left: 1rem;">
                            Roll Over
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function rolloverSingleTask(taskId) {
            const activeDailyTasks = dailyTasks.filter(t => !t.completed);
            
            if (activeDailyTasks.length >= 10) {
                alert('You have already reached your daily focus task limit (10 tasks)');
                return;
            }
            
            const previousTasks = JSON.parse(localStorage.getItem('taskManagerPreviousDailyTasks') || '[]');
            const taskToRollover = previousTasks.find(task => task.id === taskId);
            
            if (taskToRollover && !dailyTasks.find(dt => dt.id === taskId)) {
                const rolledTask = {
                    ...taskToRollover,
                    addedToDaily: new Date().toISOString(),
                    rolledOver: true
                };
                dailyTasks.push(rolledTask);
                saveToStorage();
                renderDailyTasks();
                updateDailyView();
                checkForRolloverTasks();
            }
        }

        function rolloverAllTasks() {
            const activeDailyTasks = dailyTasks.filter(t => !t.completed);
            const previousTasks = JSON.parse(localStorage.getItem('taskManagerPreviousDailyTasks') || '[]');
            const today = new Date().toDateString();
            
            const rolloverTasks = previousTasks.filter(task => 
                !task.completed && 
                new Date(task.addedToDaily || task.createdAt).toDateString() !== today &&
                !dailyTasks.find(dt => dt.id === task.id)
            );
            
            const availableSlots = 10 - activeDailyTasks.length;
            
            if (rolloverTasks.length > availableSlots) {
                if (!confirm(`You can only roll over ${availableSlots} task(s) due to the daily limit. Continue with the first ${availableSlots} tasks?`)) {
                    return;
                }
            }
            
            const tasksToAdd = rolloverTasks.slice(0, availableSlots);
            
            tasksToAdd.forEach(task => {
                const rolledTask = {
                    ...task,
                    addedToDaily: new Date().toISOString(),
                    rolledOver: true
                };
                dailyTasks.push(rolledTask);
            });
            
            saveToStorage();
            renderDailyTasks();
            updateDailyView();
            checkForRolloverTasks();
        }

        function renderCompletedTasksHistory() {
            const container = document.getElementById('completed-tasks-container');
            
            if (completedTasksHistory.length === 0) {
                container.innerHTML = '<p class="text-center text-gray py-8">No completed tasks yet.</p>';
                return;
            }
            
            // Group completed tasks by date
            const tasksByDate = {};
            completedTasksHistory.forEach(task => {
                const completedDate = new Date(task.completedDate).toDateString();
                if (!tasksByDate[completedDate]) {
                    tasksByDate[completedDate] = [];
                }
                tasksByDate[completedDate].push(task);
            });
            
            // Sort dates (most recent first)
            const sortedDates = Object.keys(tasksByDate).sort((a, b) => new Date(b) - new Date(a));
            
            let html = '';
            sortedDates.forEach(dateStr => {
                const tasks = tasksByDate[dateStr];
                const date = new Date(dateStr);
                const isToday = date.toDateString() === new Date().toDateString();
                const isYesterday = date.toDateString() === new Date(Date.now() - 86400000).toDateString();
                
                let displayDate = date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                if (isToday) displayDate = `Today (${displayDate})`;
                else if (isYesterday) displayDate = `Yesterday (${displayDate})`;
                
                html += `
                    <div class="category-section" style="margin-bottom: 1.5rem;">
                        <div class="category-header" onclick="toggleCompletedDate('${dateStr}')" style="cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span>‚úÖ</span>
                                <span class="font-bold">${displayDate} (${tasks.length} tasks)</span>
                            </div>
                            <span id="completed-chevron-${dateStr}">‚ñº</span>
                        </div>
                        <div class="category-content" id="completed-content-${dateStr}" style="padding: 0.75rem;">
                            ${tasks.map(task => `
                                <div class="task-item ${task.category}" style="opacity: 0.8;">
                                    <div class="checkbox checked">‚úì</div>
                                    <div class="task-content">
                                        <div class="task-text completed">${task.text}</div>
                                        <div class="task-meta">
                                            <span class="badge ${categories[task.category]?.badge || 'badge-personal'}">${categories[task.category]?.name || 'Personal'}</span>
                                            <span class="badge badge-${task.priority}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                                            <span style="font-size: 0.75rem; color: #6b7280; margin-left: 0.5rem;">
                                                Completed at ${new Date(task.completedDate).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleCompletedDate(dateStr) {
            const content = document.getElementById(`completed-content-${dateStr}`);
            const chevron = document.getElementById(`completed-chevron-${dateStr}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                chevron.textContent = '‚ñ∂';
            }
        }
    </script>
</body>
</html>
